<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add New Contact</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <style>
        * { box-sizing: border-box; }
        body { margin: 0; font-family: Arial, Helvetica, sans-serif; }
        .topnav { overflow: hidden; background-color: #307c68; }
        .topnav a { float: left; display: block; color: whitesmoke; text-align: center; padding: 1% 14.99%; text-decoration: none; font-size: 17px; }
        .topnav a:hover { background-color: #48b296; color: white; }
        .topnav a.active { background-color: #48b296; color: white; }
        .topnav .search-container { float: left; width: 99%; margin-left: 0.55%; }
        .topnav input[type="text"] { float: left; width: 97%; padding: 6px; font-size: 17px; border: none; margin-top: 0.55%; }
        .topnav .search-container button { float: right; padding: 0.4% 0.6%; margin-top: 0.55%; background: #ddd; font-size: 17px; border: none; cursor: pointer; }
        .topnav .search-container button:hover { background: #ccc; }
        @media screen and (max-width: 600px) {
            .topnav .search-container { width: 100%; float: none; }
            .topnav a, .topnav input[type="text"], .topnav .search-container button { float: none; display: block; text-align: left; width: 100%; margin: 0; padding: 14px; }
            .topnav input[type="text"] { border: 1px solid #ccc; }
        }
        img { display: block; margin-left: auto; margin-right: auto; }
        .plus-button:hover { background-color: #48b296; }
        .plus-button { font-size: 50px; width: 100px; height: 100px; background-color: #307c68; color: white; border: none; border-radius: 50%; display: flex; justify-content: center; align-items: center; cursor: pointer; margin: 100px; }
    </style>
</head>
<body style="background-color:#256252;">
    <img src="Hiccup_Logo.jpg" alt="Hiccup Logo" width="600" height="150">
    <div class="topnav">
        <a href="home.html">Home</a>
        <a href="about.html">About</a>
        <a href="contact.html">Contact</a>
    </div>

    <form id="addContactForm">
        <h1 style="color:white;">Add a New Point of Contact</h1>
        <p style="color:white;">First Name: <input type="text" id="first_name" name="first_name" required></p><br>
        <p style="color:white;">Last Name: <input type="text" id="last_name" name="last_name" required></p><br>
        <p style="color:white;">Email: <input type="email" id="email" name="email" required></p><br>
        <p style="color:white;">Chat Username: <input type="text" id="chat_username" name="chat_username" required></p><br>
        <p style="color:white;">Location: <input type="text" id="location" name="location" required></p><br>
        <p style="color:white;">Title: <input type="text" id="title" name="title" required></p><br>
        <p style="color:white;">Product Name: <input type="text" id="product_name" name="product_name"></p><br>
        <p style="color:white;">Repository Name: <input type="text" id="repository_name" name="repository_name"></p><br>
        <button type="submit">Add Contact</button>
    </form>

    <div id="message" style="color:white; text-align:center; margin-top:20px;"></div>

    <script>
        // Handle form submission
        document.getElementById("addContactForm").addEventListener("submit", function(event) {
            event.preventDefault();  // Prevent form submission

            // Gather form data
            const formData = new FormData(event.target);
            const contactData = {};
            formData.forEach((value, key) => {
                contactData[key] = value;
            });

            // Create the data object to send to the /add-contact API
            const requestData = {
                firstName: contactData.first_name,
                lastName: contactData.last_name,
                email: contactData.email,
                username: contactData.chat_username,
                location: contactData.location,
                position: contactData.title,
                productName: contactData.product_name || null,
                repositoryName: contactData.repository_name || null
            };

            // Step 1: Add the contact using /add-contact endpoint
            fetch('http://127.0.0.1:5000/add-contact', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === "success") {
                    const contactID = data.userID; // The ID generated for the contact

                    // Step 2: Add repository if provided
                    if (contactData.repository_name) {
                        return fetch('http://127.0.0.1:5000/add-repo', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ user_id: contactID, repo_name: contactData.repository_name })
                        });
                    }
                    return Promise.resolve(); // No repository to add
                } else {
                    throw new Error('Failed to add contact');
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === "success") {
                    // Step 3: Add product if provided
                    const contactData = new FormData(document.getElementById("addContactForm"));
                    const productName = contactData.get('product_name');
                    if (productName) {
                        const contactID = data.userID;
                        return fetch('http://127.0.0.1:5000/add-product', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ user_id: contactID, product_name: productName })
                        });
                    }
                    return Promise.resolve(); // No product to add
                }
                throw new Error('Failed to add repository');
            })
            .then(response => response.json())
            .then(data => {
                const messageContainer = document.getElementById('message');
                if (data.status === "success") {
                    messageContainer.innerHTML = `<p style="color:green;">Contact added successfully!<br>Name: ${data.firstName} ${data.lastName}</p>`;
                } else {
                    messageContainer.innerHTML = `<p style="color:red;">Error: ${data.message}</p>`;
                }
            })
            .catch(error => {
                document.getElementById('message').innerHTML = `<p style="color:red;">Error: Could not add contact. Please try again later.</p>`;
            });
        });
    </script>
</body>
</html>
